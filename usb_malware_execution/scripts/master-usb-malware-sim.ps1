<#
.SYNOPSIS
Simulates USB-based malware execution with realistic user timing and artifact cleanup.

.DESCRIPTION
This PowerShell master script orchestrates a USB malware simulation by performing these actions in sequence:
1. Simulates mounting a USB drive (using a helper script).
2. Copies a malicious launcher script onto the simulated USB drive.
3. Executes the malicious launcher, which downloads and runs a fake malware payload.
4. Cleans up downloaded payload files and removes USB artifacts to mimic operational cover-up.
5. Simulates unmounting the USB drive.

This script is designed to generate realistic logs and artifacts useful for threat hunting and incident response training.

.PARAMETER None

.EXAMPLE
.\master-usb-malware-sim.ps1

.NOTES
Author: Jason Nguyen
Date: 2025-07-02
GitHub: https://github.com/jason-p-nguyen
#>

# --- Config ---
$usbDrive = "E:"
$payloadFolder = "$usbDrive\Payload"
$maliciousLauncher = "malicious-usb-launcher.ps1"
$fakeMalwareUrl = "https://raw.githubusercontent.com/jason-p-nguyen/malware-sim/main/fake-malware.ps1"
$localPayloadPath = "C:\Temp\payload.ps1"

# --- Step 1: Mount USB drive (simulate) ---
Write-Host "Mounting USB drive $usbDrive..."
Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File .\usb-mount.ps1" -Wait
Start-Sleep -Seconds 10

# --- Step 2: Copy malicious launcher script to USB Payload folder ---
Write-Host "Creating payload folder and copying malicious launcher..."
if (-Not (Test-Path $payloadFolder)) {
    New-Item -ItemType Directory -Path $payloadFolder -Force
}
Copy-Item -Path ".\$maliciousLauncher" -Destination $payloadFolder -Force
Start-Sleep -Seconds 15

# --- Step 3: Execute malicious launcher ---
Write-Host "Running malicious USB launcher script..."
$launcherPath = Join-Path $payloadFolder $maliciousLauncher
Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File `"$launcherPath`"" -Wait
Start-Sleep -Seconds 20

# --- Step 4: Cleanup phase ---

Write-Host "Cleaning up downloaded payload and USB artifacts..."

# Remove downloaded payload
if (Test-Path $localPayloadPath) {
    Remove-Item -Path $localPayloadPath -Force
    Write-Host "Deleted $localPayloadPath"
}

# Remove malicious launcher script from USB
if (Test-Path $launcherPath) {
    Remove-Item -Path $launcherPath -Force
    Write-Host "Deleted $launcherPath"
}

# Optional: Remove Payload folder if empty
try {
    Remove-Item -Path $payloadFolder -Force -Recurse -ErrorAction Stop
    Write-Host "Removed payload folder $payloadFolder"
} catch {
    Write-Warning "Could not remove payload folder (might not be empty): $_"
}

Start-Sleep -Seconds 10

# --- Step 5: Unmount USB drive (simulate) ---
Write-Host "Unmounting USB drive $usbDrive..."
Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File .\usb-unmount.ps1" -Wait
Start-Sleep -Seconds 10

Write-Host "USB malware simulation completed."
