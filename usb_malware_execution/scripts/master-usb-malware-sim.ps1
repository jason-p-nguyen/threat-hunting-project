# Simulates USB malware execution with realistic timing and cleanup

# This script creates a usb-mount simulation, launches a malicious script from the usb, downloads fake-malware.ps1 from an external source, executes the fake-malware, removes traces, and removes the USB.

# --- Config ---
$usbDrive = "E:"
$payloadFolder = "$usbDrive\Payload"
$maliciousLauncher = "malicious-usb-launcher.ps1"
$fakeMalwareUrl = "https://raw.githubusercontent.com/jason-p-nguyen/malware-sim/main/fake-malware.ps1"
$localPayloadPath = "C:\Temp\payload.ps1"

# --- Step 1: Mount USB drive (simulate) ---
Write-Host "Mounting USB drive $usbDrive..."
Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File .\usb-mount.ps1" -Wait
Start-Sleep -Seconds 10

# --- Step 2: Copy malicious launcher script to USB Payload folder ---
Write-Host "Creating payload folder and copying malicious launcher..."
if (-Not (Test-Path $payloadFolder)) {
    New-Item -ItemType Directory -Path $payloadFolder -Force
}
Copy-Item -Path ".\$maliciousLauncher" -Destination $payloadFolder -Force
Start-Sleep -Seconds 15

# --- Step 3: Execute malicious launcher ---
Write-Host "Running malicious USB launcher script..."
$launcherPath = Join-Path $payloadFolder $maliciousLauncher
Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File `"$launcherPath`"" -Wait
Start-Sleep -Seconds 20

# --- Step 4: Cleanup phase ---

Write-Host "Cleaning up downloaded payload and USB artifacts..."

# Remove downloaded payload
if (Test-Path $localPayloadPath) {
    Remove-Item -Path $localPayloadPath -Force
    Write-Host "Deleted $localPayloadPath"
}

# Remove malicious launcher script from USB
if (Test-Path $launcherPath) {
    Remove-Item -Path $launcherPath -Force
    Write-Host "Deleted $launcherPath"
}

# Optional: Remove Payload folder if empty
try {
    Remove-Item -Path $payloadFolder -Force -Recurse -ErrorAction Stop
    Write-Host "Removed payload folder $payloadFolder"
} catch {
    Write-Warning "Could not remove payload folder (might not be empty): $_"
}

Start-Sleep -Seconds 10

# --- Step 5: Unmount USB drive (simulate) ---
Write-Host "Unmounting USB drive $usbDrive..."
Start-Process -FilePath "powershell.exe" -ArgumentList "-ExecutionPolicy Bypass -File .\usb-unmount.ps1" -Wait
Start-Sleep -Seconds 10

Write-Host "USB malware simulation completed."
